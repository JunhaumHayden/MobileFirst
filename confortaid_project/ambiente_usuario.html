<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ComfortAid Profissional</title>
    <link rel="shortcut icon" type="imagex/png" href="/PHP/assets/icon.ico">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,300;1,200;1,400&family=Red+Hat+Display:wght@400;500;700&family=Roboto&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="./assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/1.3.5/axios.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        .container_inner {
            display: flex;
            justify-content: space-evenly;
            flex-wrap: wrap;
            gap: 6rem;
            padding: 1rem;
            margin-bottom: 15rem;
            background-color: #f5f5f5;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            margin: 10rem;
        }
        .hidden {
            display: none;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
        }
        .form-group button {
            width: 100%;
            padding: 10px;
            background-color: #007BFF;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .form-group button:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>
    <header class="text-center py-4 bg-primary text-white">
        <h1>üåê ComfortAid üêò</h1>
    </header>
    <!-- barra de navegacao da Aplica√ß√£o -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container-fluid">
            <!-- Bot√£o do menu de hamb√∫rguer -->
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
    
            <!-- Itens do menu -->
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item">
                        <a class="nav-link" href="../../PHP/index.html">In√≠cio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="indexx.html">Voltar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="tel:+5548988900001">Contato</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>
    <div class="container_inner">
        <div id="login-page">
            <h2 class="text-center">Login</h2>
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="password">Senha</label>
                <input type="password" id="password" class="form-control" required>
            </div>
            <div class="form-group">
                <button class="btn btn-primary" onclick="login()">Entrar</button>
            </div>
        </div>
        <div id="professional-page" class="hidden">
            <nav class="navigation d-flex justify-content-around mb-4">
                <button type="button" class="btn btn-primary" onclick="navega('home')">
                    <i class="fa-solid fa-home"></i> Home
                </button>
                <button type="button" class="btn btn-primary" onclick="navega('update-data')">
                    <i class="fa-solid fa-concierge-bell"></i> Atualizar Dados
                </button>
                <button type="button" class="btn btn-primary" onclick="navega('new-service')">
                    <i class="fa-solid fa-file"></i> Cadastrar Novo Servi√ßo
                </button>
                <button type="button" class="btn btn-primary" onclick="navega('Reviews')">
                    <i class="fa-solid fa-star"></i> Avalia√ß√µes
                </button>
                <button type="button" class="btn btn-primary" onclick="logout()">
                    <i class="fa-solid fa-right-from-bracket"></i> Sair
                </button>
            </nav>
            <div id="home" class="tela show">
                <h3>HOME</h3>
                <h2>Bem-vindo, <span id="professional-name"></span></h2>
                <button class="btn btn-secondary" onclick="navega('update-data')">Atualizar Dados</button>
                <button class="btn btn-secondary" onclick="navega('new-service')">Cadastrar Novo Servi√ßo</button>
                <!-- <h4>Agendamentos Programados</h4>
                <div class="row" id="scheduled-appointments"></div>
                <div id="error-message" class="error-message"></div>
                <ul id="appointments-list"></ul>
                <div id="presentation-content"></div> -->
                <div class="container mt-4">
                    <h4>Agendamentos Programados</h4>
                    <div class="row" id="scheduled-appointments"></div>
                    <div id="error-message" class="text-danger mt-2"></div>
                </div>
            </div>
            <div id="update-data" class="tela collapse">
                <h3>Atualizar Dados</h3>
                <!-- Formul√°rio para atualizar dados -->
            </div>
            <div id="new-service" class="tela collapse">
                <h3>Cadastrar Novo Servi√ßo</h3>
                <!-- Formul√°rio para cadastrar novo servi√ßo -->
            </div>
            <div id="Reviews" class="tela collapse">
                <div class="container">
                    <div class="row">
                        <div class="col-md-8">
                            <h3>Avalia√ß√µes</h3>
                            <div id="reviews-list" class="list-group"></div>
                        </div>
                        <div class="col-md-4">
                            <h4>Links Patrocinados</h4>
                            <div class="list-group">
                                <a href="https://junhaumhayden.github.io/publish/" class="list-group-item list-group-item-action">Landingpage</a>
                                <a href="https://junhaumhayden.github.io/publish/flexturismo.html" class="list-group-item list-group-item-action">FlexTurismo</a>
                                <a href="https://junhaumhayden.github.io/publish/gatinhos.html" class="list-group-item list-group-item-action">Ver Gatinhos Fofinhos</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="cliente-page" class="hidden">
            <!-- Similar structure to professional-page -->
        </div>
    </div>
    <footer class="bg-light text-center py-3">
        <div class="container">
            <div class="row">
                <div class="col">
                    <img src="/PHP/assets/icons/icon36x36.ico" width="30" alt="Logo">
                    <div>&copy; 2024 HTML / CSS / JavaScript / BootStrap</div>
                    <div>Desenvolvido por: Carlos Hayden Junior</div>
                </div>
                <div class="col">
                    <img src="/PHP/assets/icons/icon-html5-48.png" width="20" alt="HTML Icon">
                    <img src="/PHP/assets/icons/icon-css3-48.ico" width="20" alt="CSS Icon">
                    <img src="/PHP/assets/icons/icons8-js-48.png" width="20" alt="JS Icon">
                </div>
            </div>
        </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>

        async function fetchAppointmentsProfessional() {
            try {
                const user = JSON.parse(sessionStorage.getItem('user'));
                if (!user || user.tipo !== "profissional") {
                    document.getElementById('error-message').textContent = "Erro: usu√°rio n√£o autenticado.";
                    return;
                }

                const response = await axios.get(`http://localhost:5000/agendamentos/profissional/${user.id}`);
                const appointments = response.data;

                const container = document.getElementById('scheduled-appointments');
                container.innerHTML = '';

                if (appointments.length === 0) {
                    container.innerHTML = '<p class="text-muted">Nenhum agendamento encontrado.</p>';
                    return;
                }

                appointments.forEach(async (appointment) => {
                    const cliente = appointment.cliente;
                    const servico = appointment.servico;

                    // Busca a imagem do cliente
                    let imgUrl = 'https://via.placeholder.com/50';
                    try {
                        const imgResponse = await axios.get(`http://localhost:5000/imagens/usuario/foto/${cliente.id}`, { responseType: 'blob' });
                        imgUrl = URL.createObjectURL(imgResponse.data);
                    } catch (error) {
                        console.warn("Erro ao carregar imagem do cliente", error);
                    }

                    const card = document.createElement('div');
                    card.classList.add('col-md-4', 'mb-3');
                    card.innerHTML = `
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <div class="d-flex align-items-center">
                                    <img src="${imgUrl}" class="rounded-circle me-2" width="50" height="50">
                                    <div>
                                        <h6 class="mb-0">${cliente.nome}</h6>
                                        <p class="text-muted mb-1">${servico.nome}</p>
                                    </div>
                                </div>
                                <p class="mt-2"><i class="fa-regular fa-calendar-days"></i> ${new Date(appointment.dataHora).toLocaleString()}</p>
                                <span class="badge bg-${getStatusColor(appointment.status)}">${appointment.status}</span>
                                <button class="btn btn-primary btn-sm w-100 mt-2" onclick="showAppointmentDetails(${JSON.stringify(appointment)})">
                                    Ver detalhes
                                </button>
                            </div>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error("Erro ao buscar agendamentos", error);
                document.getElementById('error-message').textContent = "Erro ao carregar agendamentos.";
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case "CONFIRMADO": return "success";
                case "CANCELADO": return "danger";
                case "PENDENTE": return "warning";
                default: return "secondary";
            }
        }

        function showAppointmentDetails(appointment) {
            const cliente = appointment.cliente;
            const servico = appointment.servico;

            const modalContent = `
                <div class="modal fade" id="appointmentModal" tabindex="-1">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Detalhes do Agendamento</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6><i class="fa-solid fa-user"></i> Cliente: ${cliente.nome}</h6>
                                <p><i class="fa-solid fa-phone"></i> ${cliente.telefone}</p>
                                <p><i class="fa-regular fa-envelope"></i> ${cliente.email}</p>
                                <hr>
                                <h6><i class="fa-solid fa-spa"></i> Servi√ßo: ${servico.nome}</h6>
                                <p>${servico.descricao}</p>
                                <p><i class="fa-regular fa-clock"></i> Dura√ß√£o: ${servico.duracao} min</p>
                                <p><i class="fa-regular fa-calendar-days"></i> Data: ${new Date(appointment.dataHora).toLocaleString()}</p>
                                <hr>
                                <h6>Endere√ßo</h6>
                                <p><i class="fa-solid fa-map-marker-alt"></i> CEP: ${cliente.cep}</p>
                                <div id="map-container" class="w-100" style="height: 300px;"></div>
                                <hr>
                                <h6>Alterar Status</h6>
                                <select class="form-select" id="status-select">
                                    <option value="CONFIRMADO">CONFIRMADO</option>
                                    <option value="CANCELADO">CANCELADO</option>
                                    <option value="PENDENTE">PENDENTE</option>
                                </select>
                                <button class="btn btn-primary mt-2 w-100" onclick="updateAppointmentStatus(${appointment.id})">
                                    Atualizar Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalContent);
            new bootstrap.Modal(document.getElementById('appointmentModal')).show();

            // Buscar endere√ßo no mapa
            loadMap(cliente.cep);
        }

        async function loadMap(cep) {
            try {
                const response = await axios.get(`https://viacep.com.br/ws/${cep}/json/`);
                const { logradouro, bairro, localidade, uf } = response.data;
                const fullAddress = `${logradouro}, ${bairro}, ${localidade} - ${uf}`;
                
                document.getElementById("map-container").innerHTML = `<iframe
                    width="100%"
                    height="300"
                    style="border:0"
                    loading="lazy"
                    allowfullscreen
                    referrerpolicy="no-referrer-when-downgrade"
                    src="https://www.google.com/maps/embed/v1/place?key=YOUR_GOOGLE_MAPS_API_KEY&q=${encodeURIComponent(fullAddress)}">
                </iframe>`;
            } catch (error) {
                console.error("Erro ao buscar endere√ßo", error);
                document.getElementById("map-container").innerHTML = "<p class='text-danger'>Erro ao carregar o mapa.</p>";
            }
        }

        async function updateAppointmentStatus(appointmentId) {
            try {
                const newStatus = document.getElementById('status-select').value;
                await axios.put(`http://localhost:5000/agendamentos/status/${appointmentId}`, { status: newStatus });
                alert("Status atualizado com sucesso!");
                location.reload();
            } catch (error) {
                console.error("Erro ao atualizar status", error);
                alert("Erro ao atualizar status.");
            }
        }

        // Chamar fun√ß√£o ao carregar a p√°gina
        // document.addEventListener("DOMContentLoaded", fetchAppointmentsProfessional);

        //#############################################
        // Fun√ß√µes de autentica√ß√£o e sess√£o
        function saveSession(user) {
            sessionStorage.setItem('user', JSON.stringify(user));
        }

        function getSession() {
            return JSON.parse(sessionStorage.getItem('user'));
        }

        function logout() {
            sessionStorage.clear();
            document.getElementById('professional-page').classList.add('hidden');
            document.getElementById('cliente-page').classList.add('hidden');
            document.getElementById('login-page').classList.remove('hidden');
            window.location.href = "indexx.html";
        }

        async function authenticate(email, password) {
            try {
                const response = await axios.post('http://localhost:5000/api/usuarios/login', { email, senha: password });
                const user = response.data;
                if (user) {
                    saveSession(user);
                    redirectToDashboard(user);
                } else {
                    alert('Email ou senha incorretos');
                }
            } catch (error) {
                console.error('Erro ao autenticar:', error);
                alert('Erro ao autenticar. Tente novamente mais tarde.');
            }
        }

        function redirectToDashboard(user) {
            if (user.tipo === "profissional") {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('professional-page').classList.remove('hidden');
                document.getElementById('professional-name').textContent = user.nome;
                fetchAppointmentsProfessional(user.id);
            } else if (user.tipo === "cliente") {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('cliente-page').classList.remove('hidden');
                document.getElementById('cliente-name').textContent = user.nome;
                fetchAppointmentsClient(user.id);
            } else {
                alert("Tipo de usu√°rio inv√°lido");
                logout();
            }
        }

        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            authenticate(email, password);
        }

        // Fun√ß√µes de navega√ß√£o
        function navega(destino) {
            let telas = document.getElementsByClassName('tela');
            Array.from(telas).forEach(element => {
                element.classList.remove('show');
                element.classList.add('collapse');
            });
            document.getElementById(destino).classList.remove('collapse');
            document.getElementById(destino).classList.add('show');
        }

        // Fun√ß√µes de carregamento de dados
        async function fetchAppointmentsProfessional(professionalId) {
            try {
                const response = await axios.get(`http://localhost:5000/agendamentos/profissional/${professionalId}`);
                const appointments = response.data;
                const appointmentsList = document.getElementById('appointments-list');
                appointmentsList.innerHTML = '';

                appointments.forEach(appointment => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('appointment-card');
                    listItem.innerHTML = `
                        <h4>${appointment.servico.nome}</h4>
                        <p>Cliente: ${appointment.cliente.nome}</p>
                        <p>Data: ${new Date(appointment.dataHora).toLocaleString()}</p>
                    `;
                    listItem.onclick = () => showAppointmentDetails(appointment);
                    appointmentsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao buscar agendamentos:', error);
                alert('Erro ao buscar agendamentos. Tente novamente mais tarde.');
            }
        }

        async function fetchAppointmentsClient(clienteId) {
            try {
                const response = await axios.get(`http://localhost:5000/agendamentos/cliente/${clienteId}`);
                const appointments = response.data;
                const appointmentsList = document.getElementById('appointments-list');
                appointmentsList.innerHTML = '';

                appointments.forEach(appointment => {
                    const listItem = document.createElement('li');
                    listItem.classList.add('appointment-card');
                    listItem.innerHTML = `
                        <h4>${appointment.servico.nome}</h4>
                        <p>Profissional: ${appointment.profissional.nome}</p>
                        <p>Data: ${new Date(appointment.dataHora).toLocaleString()}</p>
                    `;
                    listItem.onclick = () => showAppointmentDetails(appointment);
                    appointmentsList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao buscar agendamentos:', error);
                alert('Erro ao buscar agendamentos. Tente novamente mais tarde.');
            }
        }

        function showAppointmentDetails(appointment) {
            alert(`
                Servi√ßo: ${appointment.servico.nome}
                Cliente: ${appointment.cliente.nome}
                Data: ${new Date(appointment.dataHora).toLocaleString()}
                Descri√ß√£o: ${appointment.servico.descricao}
                Pre√ßo: R$${appointment.servico.preco}
                Dura√ß√£o: ${appointment.servico.duracao} minutos
            `);
        }

        // Fun√ß√µes de carregamento de avalia√ß√µes
        function carregarAvaliacoes() {
            axios.get('http://localhost:5000/avaliacoes')
                .then(response => {
                    const reviewsList = document.getElementById('reviews-list');
                    reviewsList.innerHTML = '';
                    response.data.forEach(avaliacao => {
                        const reviewItem = document.createElement('div');
                        reviewItem.className = 'list-group-item';
                        reviewItem.innerHTML = `
                            <h5 class="mb-1">${avaliacao.cliente.nome}</h5>
                            <p class="mb-1">${avaliacao.comentario}</p>
                            <small>Nota: ${avaliacao.nota} - Servi√ßo: ${avaliacao.servico.nome}</small>
                        `;
                        reviewsList.appendChild(reviewItem);
                    });
                })
                .catch(error => {
                    console.error('Erro ao carregar as avalia√ß√µes:', error);
                    document.getElementById('reviews-list').innerHTML = 'Ocorreu um erro ao carregar as avalia√ß√µes. Tente novamente mais tarde.';
                });
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            const user = getSession();
            if (user) {
                redirectToDashboard(user);
            }
        });

        document.querySelector('button[onclick="navega(\'update-data\')"]').addEventListener('click', carregarAtualizarDados);
        document.querySelector('button[onclick="navega(\'new-service\')"]').addEventListener('click', cadastrarNovoServico);
        document.querySelector('button[onclick="navega(\'Reviews\')"]').addEventListener('click', carregarAvaliacoes);
    </script>
</body>
</html>